<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All License Keys | Ms-Nexus</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a0e2a 0%, #1a1b3a 50%, #0c0f2a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(15, 20, 45, 0.85);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(to right, #6c8cff, #b0c6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-box {
            background: rgba(108, 140, 255, 0.2);
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #aaa;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: #6c8cff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: #5a7bff;
            transform: translateY(-2px);
        }
        
        .control-btn.export {
            background: #4CAF50;
        }
        
        .control-btn.refresh {
            background: #2196F3;
        }
        
        .control-btn.home {
            background: #9C27B0;
        }
        
        .loading {
            text-align: center;
            font-size: 1.2em;
            margin: 50px 0;
            color: #6c8cff;
        }
        
        .keys-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .key-card {
            background: rgba(30, 35, 70, 0.7);
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid #6c8cff;
            transition: transform 0.3s;
        }
        
        .key-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .key-card.expired {
            border-left-color: #f44336;
            opacity: 0.7;
        }
        
        .key-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .key-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .key-status.active {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }
        
        .key-status.expired {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        
        .key-value {
            font-family: 'Courier New', monospace;
            font-size: 1.3em;
            color: #4CAF50;
            margin-bottom: 15px;
            word-break: break-all;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }
        
        .key-info {
            font-size: 0.9em;
            color: #aaa;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .key-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .key-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            flex: 1;
            transition: background 0.3s;
        }
        
        .key-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .key-btn.copy {
            background: rgba(33, 150, 243, 0.3);
        }
        
        .key-btn.copy:hover {
            background: rgba(33, 150, 243, 0.5);
        }
        
        .no-keys {
            text-align: center;
            grid-column: 1 / -1;
            padding: 50px;
            color: #888;
            font-size: 1.2em;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #666;
            font-size: 0.9em;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .keys-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .control-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã All Ms-Nexus License Keys</h1>
            <p>All generated keys are stored here for easy access and scanning</p>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="totalKeys">0</div>
                    <div class="stat-label">Total Keys</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="validKeys">0</div>
                    <div class="stat-label">Valid Keys</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="expiredKeys">0</div>
                    <div class="stat-label">Expired Keys</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="lastUpdate">--:--</div>
                    <div class="stat-label">Last Updated</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="control-btn refresh" onclick="loadKeys()">üîÑ Refresh Keys</button>
            <button class="control-btn export" onclick="exportKeys()">üì• Export as Text</button>
            <button class="control-btn" onclick="generateNewKey()">üîë Generate New Key</button>
            <button class="control-btn home" onclick="goHome()">üè† Back to Home</button>
        </div>
        
        <div class="loading" id="loading">Loading keys...</div>
        
        <div class="keys-container" id="keysContainer">
            <!-- Keys will be loaded here by JavaScript -->
        </div>
        
        <div class="footer">
            <p>¬© 2024 Ms-Nexus System | Keys are stored in memory and may reset on server restart</p>
            <p>Auto-refresh every 60 seconds | Current time: <span id="currentTime"></span></p>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let allKeysData = [];
        let refreshInterval;
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÂç°ÂØÜ
        document.addEventListener('DOMContentLoaded', function() {
            loadKeys();
            startAutoRefresh();
            updateCurrentTime();
        });
        
        // Âä†ËΩΩÊâÄÊúâÂç°ÂØÜ
        async function loadKeys() {
            const loading = document.getElementById('loading');
            const keysContainer = document.getElementById('keysContainer');
            
            loading.style.display = 'block';
            keysContainer.innerHTML = '';
            
            try {
                const response = await fetch('/api/keys');
                const data = await response.json();
                
                if (data.success) {
                    allKeysData = data.data.allKeys || [];
                    
                    // Êõ¥Êñ∞ÁªüËÆ°
                    updateStats(data.data);
                    
                    // ÊòæÁ§∫Âç°ÂØÜ
                    displayKeys(allKeysData);
                    
                    // Êõ¥Êñ∞Êó∂Èó¥
                    updateLastUpdate();
                } else {
                    keysContainer.innerHTML = `<div class="no-keys">Error: ${data.message}</div>`;
                }
            } catch (error) {
                console.error('Error loading keys:', error);
                keysContainer.innerHTML = `<div class="no-keys">Error loading keys: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // ÊòæÁ§∫Âç°ÂØÜ
        function displayKeys(keys) {
            const keysContainer = document.getElementById('keysContainer');
            
            if (keys.length === 0) {
                keysContainer.innerHTML = `<div class="no-keys">No keys generated yet. Generate your first key!</div>`;
                return;
            }
            
            // ÊåâÁîüÊàêÊó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢Ôºâ
            const sortedKeys = [...keys].sort((a, b) => b.id - a.id);
            
            // ÂàõÂª∫Âç°ÂØÜÂç°Áâá
            sortedKeys.forEach((key, index) => {
                const now = Math.floor(Date.now() / 1000);
                const isExpired = key.expiresAt < now;
                const isActive = key.status === 'active';
                
                // ËÆ°ÁÆóÂâ©‰ΩôÊó∂Èó¥
                const remaining = key.expiresAt - now;
                const hours = Math.floor(remaining / 3600);
                const minutes = Math.floor((remaining % 3600) / 60);
                
                const keyCard = document.createElement('div');
                keyCard.className = `key-card ${isExpired ? 'expired' : ''}`;
                
                keyCard.innerHTML = `
                    <div class="key-header">
                        <strong>Key #${sortedKeys.length - index}</strong>
                        <span class="key-status ${isExpired ? 'expired' : 'active'}">
                            ${isExpired ? '‚ùå Expired' : '‚úÖ Active'}
                        </span>
                    </div>
                    <div class="key-value">${key.licenseKey}</div>
                    <div class="key-info">
                        <div><strong>Generated:</strong> ${key.generatedAt}</div>
                        <div><strong>Expires:</strong> ${key.expiresAtReadable}</div>
                        ${!isExpired ? 
                            `<div><strong>Remaining:</strong> ${hours}h ${minutes}m</div>` :
                            '<div><strong>Status:</strong> Expired</div>'
                        }
                        <div><strong>ID:</strong> ${key.id}</div>
                    </div>
                    <div class="key-actions">
                        <button class="key-btn copy" onclick="copySingleKey('${key.licenseKey}')">Copy</button>
                        <button class="key-btn" onclick="checkKeyDetails('${key.licenseKey}')">Details</button>
                        ${!isExpired ? 
                            `<button class="key-btn" onclick="useKey('${key.licenseKey}')">Use</button>` :
                            ''
                        }
                    </div>
                `;
                
                keysContainer.appendChild(keyCard);
            });
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStats(data) {
            const totalKeys = data.totalCount || 0;
            const validKeys = data.validCount || 0;
            const expiredKeys = totalKeys - validKeys;
            
            document.getElementById('totalKeys').textContent = totalKeys;
            document.getElementById('validKeys').textContent = validKeys;
            document.getElementById('expiredKeys').textContent = expiredKeys;
        }
        
        // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
        function updateLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = timeString;
        }
        
        // Êõ¥Êñ∞ÂΩìÂâçÊó∂Èó¥
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
            
            setTimeout(updateCurrentTime, 1000);
        }
        
        // Â§çÂà∂Âçï‰∏™Âç°ÂØÜ
        function copySingleKey(key) {
            navigator.clipboard.writeText(key).then(() => {
                alert(`Copied: ${key}`);
            }).catch(err => {
                alert('Failed to copy. Please copy manually.');
            });
        }
        
        // Ê£ÄÊü•Âç°ÂØÜËØ¶ÊÉÖ
        function checkKeyDetails(key) {
            const keyData = allKeysData.find(k => k.licenseKey === key);
            if (keyData) {
                const now = Math.floor(Date.now() / 1000);
                const isExpired = keyData.expiresAt < now;
                const remaining = keyData.expiresAt - now;
                const hours = Math.floor(remaining / 3600);
                const minutes = Math.floor((remaining % 3600) / 60);
                
                alert(`Key Details:\n\n` +
                      `License Key: ${keyData.licenseKey}\n` +
                      `Generated: ${keyData.generatedAt}\n` +
                      `Expires: ${keyData.expiresAtReadable}\n` +
                      `Status: ${isExpired ? 'Expired' : 'Active'}\n` +
                      `${!isExpired ? `Remaining: ${hours}h ${minutes}m\n` : ''}` +
                      `ID: ${keyData.id}`);
            }
        }
        
        // ‰ΩøÁî®Âç°ÂØÜ
        function useKey(key) {
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†‰ΩøÁî®Âç°ÂØÜÁöÑÈÄªËæë
            alert(`Using key: ${key}\n\nThis key is now marked as used.`);
            
            // Ê®°ÊãüÊ†áËÆ∞Âç°ÂØÜ‰∏∫Â∑≤‰ΩøÁî®
            const keyIndex = allKeysData.findIndex(k => k.licenseKey === key);
            if (keyIndex !== -1) {
                allKeysData[keyIndex].status = 'used';
                // ÈáçÊñ∞Âä†ËΩΩ‰ª•Êõ¥Êñ∞Áä∂ÊÄÅ
                setTimeout(loadKeys, 1000);
            }
        }
        
        // ÂØºÂá∫Âç°ÂØÜ‰∏∫ÊñáÊú¨
        function exportKeys() {
            if (allKeysData.length === 0) {
                alert('No keys to export');
                return;
            }
            
            const now = new Date();
            let text = '=== Ms-Nexus License Keys Export ===\n';
            text += `Export Date: ${now.toISOString()}\n`;
            text += `Total Keys: ${allKeysData.length}\n\n`;
            
            // ÊúâÊïàÂç°ÂØÜ
            const validKeys = allKeysData.filter(key => {
                const isExpired = key.expiresAt < Math.floor(Date.now() / 1000);
                return !isExpired && (key.status === 'active' || !key.status);
            });
            
            text += `=== VALID KEYS (${validKeys.length}) ===\n\n`;
            validKeys.forEach((key, index) => {
                text += `${index + 1}. ${key.licenseKey}\n`;
                text += `   Expires: ${key.expiresAtReadable}\n`;
                text += `   Generated: ${key.generatedAt}\n\n`;
            });
            
            // ËøáÊúüÂç°ÂØÜ
            const expiredKeys = allKeysData.filter(key => {
                const isExpired = key.expiresAt < Math.floor(Date.now() / 1000);
                return isExpired;
            });
            
            if (expiredKeys.length > 0) {
                text += `=== EXPIRED KEYS (${expiredKeys.length}) ===\n\n`;
                expiredKeys.forEach((key, index) => {
                    text += `${index + 1}. ${key.licenseKey}\n`;
                    text += `   Expired: ${key.expiresAtReadable}\n`;
                    text += `   Generated: ${key.generatedAt}\n\n`;
                });
            }
            
            // ÂàõÂª∫‰∏ãËΩΩ
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `msnexus-keys-${now.toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ÁîüÊàêÊñ∞Âç°ÂØÜ
        function generateNewKey() {
            window.location.href = '/key.html';
        }
        
        // ËøîÂõûÈ¶ñÈ°µ
        function goHome() {
            window.location.href = '/index.html';
        }
        
        // ÂêØÂä®Ëá™Âä®Âà∑Êñ∞
        function startAutoRefresh() {
            // ÊØè60ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(loadKeys, 60000);
        }
        
        // ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞
        function stopAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
        }
    </script>
</body>
</html>
